<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page | MiniInstagram</title>

    <!-- Bootstrap & icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Custom style -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profile.css">
</head>

<body>
    <div class="app d-flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-dark text-white position-fixed">
            <div class="sidebar-top p-4 d-flex align-items-center">
                <img src="images/insta-logo.png" alt="logo" class="insta-logo w-25">
                <img src="images/logo-Photoroom.png" alt="logo" class="insta-logo w-50">
                <button id="sidebarClose" class="btn btn-outline-light btn-sm ms-auto d-md-none"><i
                        class="bi bi-x-lg"></i></button>
            </div>

            <nav class="nav flex-column px-2">
                <a class="nav-link text-white d-flex align-items-center" href="feed.html"><i
                        class="fa-regular fa-images me-2"></i> Feed</a>
                <a class="nav-link active text-white d-flex align-items-center" href="profile.html"><i
                        class="fa-regular fa-user me-2"></i> Profile <span
                        class="badge bg-primary ms-auto">NEW</span></a>
                <a class="nav-link text-white d-flex align-items-center" href="create.html"><i
                        class="fa-regular fa-square-plus me-2"></i>Create Post <span
                        class="badge bg-primary ms-auto">NEW</span></a>
                <a class="nav-link text-white d-flex align-items-center" href="#"><i
                        class="fa-solid fa-magnifying-glass me-2"></i> Explore</a>
                <a class="nav-link text-white d-flex align-items-center" href="#"><i
                        class="fa-solid fa-paper-plane me-2"></i> Direct Messages</a>
                <a class="nav-link text-white d-flex align-items-center" href="#"><i class="fa-solid fa-gear me-2"></i>
                    Settings</a>
            </nav>

            <div class="sidebar-footer px-3 mt-auto pb-4">
                <a href="login.html" class="text-white text-decoration-none"><i
                        class="fa-solid fa-right-from-bracket me-2"></i> Log out</a>
            </div>
        </aside>

        <div class="main flex-grow-1">
            <!-- Topbar -->
            <header class="topbar bg-dark border-bottom">
                <div class="container d-flex align-items-center gap-3 py-3">
                    <button id="toggleSidebar" class="btn btn-outline-light d-md-none"><i
                            class="bi bi-list"></i></button>
                    <h4 class="mb-0 text-white d-none d-md-block">Profile</h4>

                    <div class="ms-auto d-flex align-items-center gap-3">
                        <button id="btnCreate" class="btn btn-outline-primary d-none d-md-inline">Create Post</button>
                        <a id="btnCreateMobile" class="btn btn-primary d-md-none rounded-circle"
                            href="Instagram/create.html"><i class="bi bi-plus-lg"></i></a>

                        <div class="d-flex align-items-center gap-2">
                            <img id="navAvatar" src="https://via.placeholder.com/42" alt="avatar"
                                class="rounded-circle border" width="42" height="42">
                            <div class="d-none d-sm-block">
                                <div id="navName" class="fw-semibold text-white small"></div>
                                <div id="navHandle" class="text-secondary small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Profile Content -->
            <main class="container py-4">
                <!-- Profile Header -->
                <div class="profile-header rounded-3">
                    <img id="profileAvatar" src="https://via.placeholder.com/150" alt="Profile" class="profile-avatar">

                    <div class="profile-info">
                        <h2 id="profileName">Manthan Jadav</h2>
                        <div class="profile-handle">@manthan.py</div>
                        <div class="profile-bio">
                            <p>Digital creator | Photography enthusiast | Coffee lover â˜•</p>
                        </div>

                        <!-- Stats -->
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="postCount">0</span>
                                <span class="stat-label">Posts</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">1.2M</span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">320</span>
                                <span class="stat-label">Following</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="profile-actions">
                            <button class="btn btn-primary" id="editProfile">
                                <i class="bi bi-pencil me-2"></i>Edit Profile
                            </button>
                            <button class="btn btn-danger" id="deleteProfile">
                                <i class="bi bi-trash me-2"></i>Delete Profile
                            </button>
                            <a href="create.html">
                                <button class="btn btn-outline-primary">
                                    <i class="bi bi-plus-lg me-2"></i>Add New Post
                                </button>
                            </a>

                        </div>
                    </div>
                </div>

                <!-- Gallery Section -->
                <div class="gallery-section">
                    <div class="gallery-header">
                        <h3><i class="bi bi-images me-2"></i>My Posts</h3>
                        <small class="text-muted">12 posts</small>
                    </div>

                    <div class="gallery-grid" id="profileGallery">
                        <!-- Posts will be loaded here -->
                    </div>
                </div>
            </main>
            <!-- Edit Profile Modal -->
            <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content"
                        style="background:#0f1724; color:#e6eef6; border: 1px solid rgba(255,255,255,0.08);">
                        <form id="editProfileForm">
                            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Profile</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>

                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Name</label>
                                    <input type="text" id="editName" class="form-control" placeholder="Enter your name"
                                        required
                                        style="background-color: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color:#e6eef6;">
                                    <div class="invalid-feedback">Name cannot be empty.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="editBio" class="form-label">Bio</label>
                                    <textarea id="editBio" class="form-control" rows="3"
                                        placeholder="Tell something about yourself"
                                        style="background-color: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color:#e6eef6;"></textarea>
                                </div>
                            </div>

                            <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.08);">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary"
                                    style="background: linear-gradient(135deg, #0ea5a4, #06b6d4); border:0;">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery + Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Profile JS -->
    <script>
        $(function () {
            // ========================================
            // SESSION VALIDATION
            // ========================================

            // Function: Validate user session
            function validateSession() {
                const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
                const sessionId = localStorage.getItem("sessionId");

                // Check if user is logged in and has valid session
                if (!loggedInUser || !sessionId || loggedInUser.sessionId !== sessionId) {
                    // No valid session, redirect to login
                    window.location.href = "login.html";
                    return null;
                }

                return loggedInUser;
            }

            // Validate session on page load
            const loggedInUserData = validateSession();
            if (!loggedInUserData) return; // Exit if not logged in

            // ========================================
            // FETCH USER DATA FROM USERS ARRAY
            // ========================================

            // Get the logged-in username from loggedInUser
            const loggedInUsername = loggedInUserData.name;

            // Fetch the complete user data from users array
            const allUsers = JSON.parse(localStorage.getItem("users")) || [];
            const currentUser = allUsers.find(u => u.username === loggedInUsername);

            if (!currentUser) {
                // User not found in users array
                alert("User data not found. Please log in again.");
                localStorage.removeItem("loggedInUser");
                localStorage.removeItem("sessionId");
                window.location.href = "login.html";
                return;
            }

            // ========================================
            // HELPER FUNCTIONS
            // ========================================

            function getInitials(name) {
                if (!name) return "U";
                const nameParts = name.trim().split(" ");
                if (nameParts.length === 1) {
                    return nameParts[0].charAt(0).toUpperCase();
                }
                const firstLetter = nameParts[0].charAt(0);
                const lastLetter = nameParts[nameParts.length - 1].charAt(0);
                return (firstLetter + lastLetter).toUpperCase();
            }

            function getAvatarColor(name) {
                const colors = ["#1f2937", "#6b21a8", "#065f46", "#0ea5a4", "#dc2626", "#f59e0b"];
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            // ---------- Helpers for profile updates ----------

            // Remove all comments by a username (including nested replies)
            function stripUserFromComments(commentsArray, username) {
                if (!Array.isArray(commentsArray)) return [];
                return commentsArray
                    .filter(c => c.user !== username) // drop comments authored by user
                    .map(c => {
                        c.replies = Array.isArray(c.replies)
                            ? c.replies.filter(r => r.user !== username) // drop replies by user
                            : [];
                        return c;
                    });
            }

            // Update displayName across posts for a username
            function updateDisplayNameInPosts(postsArray, username, newDisplayName) {
                if (!Array.isArray(postsArray)) return [];
                return postsArray.map(p => {
                    if (p?.user?.username === username) {
                        p.user.displayName = newDisplayName;
                    }
                    return p;
                });
            }


            // ========================================
            // DISPLAY USER DATA
            // ========================================

            const initials = getInitials(currentUser.name);
            const avatarColor = getAvatarColor(currentUser.name);

            // Helper: create SVG data URL for initials (keeps element as <img>)
            function makeInitialsSVG(name, bgColor, size = 150) {
                const initials = getInitials(name || "");
                const w = size;
                const h = size;
                const fontSize = Math.floor(size * 0.45);
                const svg = `<?xml version="1.0" encoding="UTF-8"?><svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>` +
                    `<rect width='100%' height='100%' fill='${bgColor}' rx='${Math.floor(w/2)}' ry='${Math.floor(h/2)}'/>` +
                    `<text x='50%' y='50%' dy='0.36em' font-family='Poppins, Arial, sans-serif' text-anchor='middle' fill='#ffffff' font-size='${fontSize}' font-weight='700'>${initials}</text>` +
                    `</svg>`;
                return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
            }

            // Set profile avatar: if user has an avatar URL use it, otherwise use SVG data URL
            const $profileAvatar = $("#profileAvatar");
            if ($profileAvatar.is('img')) {
                const avatarUrl = currentUser.avatar && currentUser.avatar.trim();
                if (avatarUrl) {
                    $profileAvatar.attr('src', avatarUrl).attr('alt', currentUser.name || 'avatar');
                } else {
                    $profileAvatar.attr('src', makeInitialsSVG(currentUser.name, avatarColor, 150)).attr('alt', currentUser.name || 'avatar');
                }
            } else {
                $profileAvatar.css({
                    "background-color": avatarColor,
                    "color": "white",
                    "display": "flex",
                    "align-items": "center",
                    "justify-content": "center",
                    "font-size": "60px",
                    "font-weight": "bold",
                }).text(initials);
            }

            $("#profileName").text(currentUser.name);
            $(".profile-handle").text("@" + currentUser.username);
            $(".profile-bio").text(currentUser.bio);

            // Display navbar user info: set <img> src or fallback to initials SVG
            const $navAvatar = $("#navAvatar");
            if ($navAvatar.is('img')) {
                const navUrl = currentUser.avatar && currentUser.avatar.trim();
                if (navUrl) {
                    $navAvatar.attr('src', navUrl).attr('alt', currentUser.name || 'avatar');
                } else {
                    $navAvatar.attr('src', makeInitialsSVG(currentUser.name, avatarColor, 42)).attr('alt', currentUser.name || 'avatar');
                }
            } else {
                $navAvatar.css({
                    "background-color": avatarColor,
                    "color": "white",
                    "display": "flex",
                    "align-items": "center",
                    "justify-content": "center",
                    "font-weight": "bold",
                    "font-size": "16px"
                }).text(initials);
            }

            $("#navName").text(currentUser.name);
            $("#navHandle").text("@" + currentUser.username);

            // ========================================
            // LOAD USER'S POSTS
            // ========================================

            const allPosts = JSON.parse(localStorage.getItem("posts")) || [];
            const userPosts = allPosts.filter(post => post.user.username === currentUser.username);

            $("#postCount").text(userPosts.length);

            // Display gallery
            const gallery = $("#profileGallery");
            if (userPosts.length > 0) {
                userPosts.forEach(post => {
                    gallery.append(`
                    <div class="gallery-item position-relative" data-post-id="${post.id}">
                        <img src="${post.image}" alt="${post.title}">
                        <div class="position-absolute top-0 end-0 p-2 d-flex gap-1">
                        <button class="btn btn-sm btn-dark bg-opacity-75 text-white btn-edit-post" data-id="${post.id}" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger bg-opacity-75 text-white btn-delete-post" data-id="${post.id}" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                        </div>
                    </div>
                    `);
                });
            } else {
                gallery.html('<p class="text-secondary w-100 text-center py-5">No posts yet</p>');
            }

            // ========================================
            // Delete Current User Profile (and related data)
            // ========================================
            $("#deleteProfile").on("click", function () {
                const proceedWithDeletion = () => {
                    const username = currentUser.username;

                    // ---- Remove from users ----
                    const allUsers = JSON.parse(localStorage.getItem("users")) || [];
                    const updatedUsers = allUsers.filter(u => u.username !== username);
                    localStorage.setItem("users", JSON.stringify(updatedUsers));

                    // ---- Posts cleanup ----
                    let posts = JSON.parse(localStorage.getItem("posts")) || [];

                    // 1) Remove this user's own posts
                    posts = posts.filter(p => p?.user?.username !== username);

                    // 2) From remaining posts: remove this user's likes, saves, comments, replies
                    posts = posts.map(p => {
                        // normalize arrays
                        p.liked_by = Array.isArray(p.liked_by) ? p.liked_by.filter(u => u !== username) : [];
                        p.saved_by = Array.isArray(p.saved_by) ? p.saved_by.filter(u => u !== username) : [];
                        p.comments = stripUserFromComments(p.comments || [], username);
                        return p;
                    });

                    localStorage.setItem("posts", JSON.stringify(posts));

                    // ---- Optional: followedUsers cleanup (if you store it globally) ----
                    // If you have a single list the current user uses:
                    // const followed = JSON.parse(localStorage.getItem("followedUsers")) || [];
                    // localStorage.setItem("followedUsers", JSON.stringify(followed.filter(u => u !== username)));

                    // ---- Clear session ----
                    localStorage.removeItem("loggedInUser");
                    localStorage.removeItem("sessionId");

                    // Redirect
                    window.location.href = "login.html";
                };

                // SweetAlert2 if available, else fallback to confirm()
                if (typeof Swal !== "undefined") {
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            proceedWithDeletion();
                        }
                    });
                } else {
                    const ok = confirm("Are you sure you want to delete your profile? This cannot be undone.");
                    if (ok) proceedWithDeletion();
                }
            });

            // ========================================
            // Edit User profile from Display and Local storage both without reload
            // ========================================
            const editModal = new bootstrap.Modal(document.getElementById('editProfileModal'));

            // Pre-fill and open modal on click
            $("#editProfile").on("click", function () {
                // Prefill inputs
                $("#editName").val(currentUser.name || "");
                $("#editBio").val(currentUser.bio || "");

                // Reset validation state
                $("#editName").removeClass("is-invalid");

                editModal.show();
            });

            // Handle form submit
            $("#editProfileForm").on("submit", function (e) {
                e.preventDefault();

                const newName = $("#editName").val().trim();
                const newBio = $("#editBio").val().trim();

                // Validation
                if (!newName) {
                    $("#editName").addClass("is-invalid").focus();
                    return;
                } else {
                    $("#editName").removeClass("is-invalid");
                }

                // ---- Update users array ----
                const users = JSON.parse(localStorage.getItem("users")) || [];
                const idx = users.findIndex(u => u.username === currentUser.username);
                if (idx === -1) {
                    alert("User record not found. Please log in again.");
                    return;
                }
                users[idx].name = newName;
                users[idx].bio = newBio;
                localStorage.setItem("users", JSON.stringify(users));

                // Update currentUser in memory
                currentUser.name = newName;
                currentUser.bio = newBio;

                // ---- Update posts displayName for this author ----
                let posts = JSON.parse(localStorage.getItem("posts")) || [];
                posts = updateDisplayNameInPosts(posts, currentUser.username, newName);
                localStorage.setItem("posts", JSON.stringify(posts));

                // ---- Update UI instantly ----
                const initials = getInitials(newName);
                const avatarColor = getAvatarColor(newName);

                // Profile avatar: update <img> src or fallback to styled element
                const $profAvatar = $("#profileAvatar");
                if ($profAvatar.is('img')) {
                    const avatarUrl = currentUser.avatar && currentUser.avatar.trim();
                    if (avatarUrl) {
                        $profAvatar.attr('src', avatarUrl).attr('alt', newName || 'avatar');
                    } else {
                        $profAvatar.attr('src', makeInitialsSVG(newName, avatarColor, 150)).attr('alt', newName || 'avatar');
                    }
                } else {
                    $profAvatar.css({
                        "background-color": avatarColor,
                        "color": "white",
                        "display": "flex",
                        "align-items": "center",
                        "justify-content": "center",
                        "font-size": "60px",
                        "font-weight": "bold",
                    }).text(initials);
                }

                // Top nav avatar: update <img> src or fallback to styled element
                const $navAv = $("#navAvatar");
                if ($navAv.is('img')) {
                    const navUrl = currentUser.avatar && currentUser.avatar.trim();
                    if (navUrl) {
                        $navAv.attr('src', navUrl).attr('alt', newName || 'avatar');
                    } else {
                        $navAv.attr('src', makeInitialsSVG(newName, avatarColor, 42)).attr('alt', newName || 'avatar');
                    }
                } else {
                    $navAv.css({
                        "background-color": avatarColor,
                        "color": "white",
                        "display": "flex",
                        "align-items": "center",
                        "justify-content": "center",
                        "font-weight": "bold",
                        "font-size": "16px"
                    }).text(initials);
                }

                $("#profileName").text(newName);
                $("#navName").text(newName);
                $(".profile-handle").text("@" + currentUser.username);
                $(".profile-bio").text(newBio);

                // Close modal
                editModal.hide();

                // Optional toast/alert
                if (typeof Swal !== "undefined") {
                    Swal.fire("Updated", "Your profile has been updated.", "success");
                }
            });
            ``

            // ========================================
            // Edit Post from Display and Local storage both without reload
            // ========================================
            const editUI = $(`
            <div class="modal fade" id="profileEditPostModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="background:#0f1724; color:#e6eef6; border:1px solid rgba(255,255,255,.08);">
                <div class="modal-header"><h5 class="modal-title">Edit Post</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="profEditPostId">
                    <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input id="profEditPostTitle" class="form-control" placeholder="Title">
                    <small id="profEditTitleError" class="text-danger d-block"></small>
                    </div>
                    <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="profEditPostDesc" class="form-control" rows="4" placeholder="Description"></textarea>
                    <small id="profEditDescError" class="text-danger d-block"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="profSavePostChanges" class="btn btn-primary">Save Changes</button>
                </div>
                </div>
            </div>
            </div>`);
            $("body").append(editUI);
            const profEditModal = new bootstrap.Modal(document.getElementById('profileEditPostModal'));

            // Open edit
            $("#profileGallery").on("click", ".btn-edit-post", function () {
            const id = $(this).data("id");
            const posts = JSON.parse(localStorage.getItem("posts")) || [];
            const post = posts.find(p => p.id === id);
            if (!post) return;

            if (post?.user?.username !== currentUser.username) return;

            $("#profEditPostId").val(id);
            $("#profEditPostTitle").val(post.title || "");
            $("#profEditPostDesc").val(post.description || "");
            $("#profEditTitleError").text("");
            $("#profEditDescError").text("");
            profEditModal.show();
            });

            // Save edit
            $("#profSavePostChanges").on("click", function () {
            const id = $("#profEditPostId").val();
            const title = ($("#profEditPostTitle").val() || "").trim();
            const desc = ($("#profEditPostDesc").val() || "").trim();
            let ok = true;

            if (title.length < 2) { $("#profEditTitleError").text("Title must be at least 2 characters"); ok = false; }
            else $("#profEditTitleError").text("");

            if (desc.length < 2) { $("#profEditDescError").text("Description must be at least 2 characters"); ok = false; }
            else $("#profEditDescError").text("");

            if (!ok) return;

            let posts = JSON.parse(localStorage.getItem("posts")) || [];
            const idx = posts.findIndex(p => p.id === id);
            if (idx === -1) return;

            if (posts[idx]?.user?.username !== currentUser.username) return;

            posts[idx].title = title;
            posts[idx].description = desc;

            localStorage.setItem("posts", JSON.stringify(posts));
            profEditModal.hide();

            // SweetAlert Timer Success
            Swal.fire({
                icon: "success",
                title: "Post Updated Successfully",
                text: "Refreshing profile...",
                timer: 1800,
                showConfirmButton: false,
                timerProgressBar: true
            }).then(() => {
                window.location.reload();
            });

            const updated = posts.filter(p => p.user.username === currentUser.username);
            $("#postCount").text(updated.length);
            updated.forEach(p => {
                $("#profileGallery").append(`
                <div class="gallery-item position-relative" data-post-id="${p.id}">
                    ${p.image}
                    <div class="position-absolute top-0 end-0 p-2 d-flex gap-1">
                    <button class="btn btn-sm btn-dark bg-opacity-75 text-white btn-edit-post" data-id="${p.id}" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger bg-opacity-75 text-white btn-delete-post" data-id="${p.id}" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                    </div>
                </div>
                `);
            });
            
            });

            // Delete
            $("#profileGallery").on("click", ".btn-delete-post", function () {
            const postId = $(this).data("id");

            const proceed = () => {
                let posts = JSON.parse(localStorage.getItem("posts")) || [];
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                if (post?.user?.username !== currentUser.username) return;

                posts = posts.filter(p => p.id !== postId);
                localStorage.setItem("posts", JSON.stringify(posts));

                // Remove from DOM
                $(`.gallery-item[data-post-id="${postId}"]`).remove();

                const mine = posts.filter(p => p.user.username === currentUser.username);
                $("#postCount").text(mine.length);
            };

            if (window.Swal && typeof Swal.fire === "function") {
                Swal.fire({
                title: 'Delete this post?',
                text: "This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete',
                confirmButtonColor: '#d33'
                }).then(res => { if (res.isConfirmed) proceed(); });
            } else {
                if (confirm("Delete this post? This cannot be undone.")) proceed();
            }
            });

            // ========================================
            // SIDEBAR & NAVIGATION
            // ========================================

            // Sidebar toggle
            $("#toggleSidebar").on("click", function () {
                $("#sidebar").toggleClass("open");
            });

            $("#sidebarClose").on("click", function () {
                $("#sidebar").removeClass("open");
            });

            // Create button click
            $("#btnCreate").on("click", function () {
                window.location.href = "Instagram/create.html";
            });
        });
    </script>
</body>

</html>